#!/bin/bash
# Install packages defined in .chezmoidata/packages.yaml
# Uses Homebrew on both macOS and Linux for consistent package versions

set -e

# Function to install Homebrew
install_homebrew() {
    if ! command -v brew &>/dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

        # Add brew to PATH for this session
        {{ if eq .chezmoi.os "linux" -}}
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        {{ else if eq .chezmoi.os "darwin" -}}
        eval "$(/opt/homebrew/bin/brew shellenv)"
        {{ end -}}
    fi
}

{{ if eq .chezmoi.os "linux" -}}
echo "Installing Linux system dependencies via apt..."

# Update package lists
sudo apt update

# Install apt packages (system dependencies)
{{ range .packages.linux.apt -}}
sudo apt install -y {{ . }} || true
{{ end }}

echo "System dependencies installed!"
{{ end }}

# Install Homebrew (works on both macOS and Linux)
echo "Checking Homebrew installation..."
install_homebrew

# Ensure brew is in PATH
{{ if eq .chezmoi.os "linux" -}}
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
{{ else if eq .chezmoi.os "darwin" -}}
eval "$(/opt/homebrew/bin/brew shellenv)"
{{ end }}

echo "Installing packages via Homebrew..."

# Install common brews (both platforms)
{{ range .packages.common.brews -}}
brew install {{ . }} || true
{{ end }}

{{ if eq .chezmoi.os "darwin" -}}
echo "Installing macOS casks..."

# Install casks (macOS only)
{{ range .packages.darwin.casks -}}
brew install --cask {{ . }} || true
{{ end }}
{{ end }}

echo "Homebrew packages installed!"

# Install tmux plugins
if [ -d "$HOME/.config/tmux/plugins/tpm" ]; then
    echo "Installing tmux plugins..."
    "$HOME/.config/tmux/plugins/tpm/bin/install_plugins"
fi

echo "Package installation complete!"
